#!/usr/bin/env bash
set -euo pipefail

# Unified AI CLI wrapper.
# Usage:
#   ./ai <backend> [prompt...]
#   echo "prompt" | ./ai <backend>

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"
AGENTS_DIR="$SCRIPT_DIR/agents"

if [[ $# -lt 1 ]]; then
  echo "Usage: $0 {openai|claude|gemini|hf|huggingface|ollama} [prompt...]" >&2
  exit 1
fi

BACKEND="$1"
shift || true

case "$BACKEND" in
  openai)
    AGENT_SCRIPT="$AGENTS_DIR/openai.sh"
    ;;
  claude)
    AGENT_SCRIPT="$AGENTS_DIR/claude.sh"
    ;;
  gemini)
    AGENT_SCRIPT="$AGENTS_DIR/gemini.sh"
    ;;
  hf|huggingface)
    AGENT_SCRIPT="$AGENTS_DIR/huggingface.sh"
    ;;
  ollama)
    AGENT_SCRIPT="$AGENTS_DIR/ollama.sh"
    ;;
  *)
    echo "Usage: $0 {openai|claude|gemini|hf|huggingface|ollama} [prompt...]" >&2
    exit 1
    ;;
esac

if [[ ! -x "$AGENT_SCRIPT" ]]; then
  echo "Error: agent script '$AGENT_SCRIPT' not found or not executable" >&2
  exit 1
fi

if [[ $# -gt 0 ]]; then
  PROMPT="$*"
  "$AGENT_SCRIPT" "$PROMPT"
else
  # Read prompt from stdin
  if ! IFS= read -r -d '' PROMPT 2>/dev/null; then
    # Fallback for non-NUL-terminated input
    PROMPT="$(cat)"
  fi
  "$AGENT_SCRIPT" "$PROMPT"
fi
